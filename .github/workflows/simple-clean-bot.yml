name: Simple Clean News Bot

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      keyword:
        description: 'Search keyword'
        required: false
        default: 'artificial intelligence'

permissions:
  contents: read
  issues: write

jobs:
  news-bot:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        pip install google-generativeai eventregistry
        
    - name: Run news bot
      env:
        EVENTREGISTRY_API_KEY: ${{ secrets.EVENTREGISTRY_API_KEY }}
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        INPUT_KEYWORD: ${{ inputs.keyword || 'artificial intelligence' }}
      run: python examples/news_bot_clean.py
      
    - name: Upload articles
      uses: actions/upload-artifact@v4
      with:
        name: news-${{ github.run_number }}
        path: "*.md"
        
    - name: Debug and create issue
      run: |
        # Create label
        gh label create "news-bot" --description "Automated news bot" --color "0E8A16" || true
        
        # Debug: Check what files were created
        echo "=== DEBUG: Files in current directory ==="
        ls -la
        echo "=== DEBUG: Looking for .md files ==="
        ls -la *.md || echo "No .md files found"
        
        # Check if articles were generated
        if ls *.md 1> /dev/null 2>&1; then
          echo "Articles found! Creating detailed issue..."
          
          # Create issue with first article content
          FIRST_FILE=$(ls *.md | head -1)
          echo "Using file: $FIRST_FILE"
          
          # Create issue body with article content
          {
            echo "# üì∞ News Bot Results"
            echo ""
            echo "**Keyword:** ${{ inputs.keyword || 'artificial intelligence' }}"
            echo "**Run:** ${{ github.run_number }}"
            echo "**Files generated:** $(ls *.md | wc -l)"
            echo ""
            echo "## Generated Article"
            echo ""
            echo '```markdown'
            head -50 "$FIRST_FILE"
            echo '```'
            echo ""
            echo "[Download all articles](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          } > issue_body.md
          
          gh issue create \
            --title "üì∞ News: ${{ inputs.keyword || 'artificial intelligence' }} (#${{ github.run_number }})" \
            --body-file issue_body.md \
            --label "news-bot"
        else
          echo "No articles generated. Creating error issue..."
          gh issue create \
            --title "‚ùå News Bot Failed (Run ${{ github.run_number }})" \
            --body "No articles were generated for: ${{ inputs.keyword || 'artificial intelligence' }}. Check the logs for errors." \
            --label "news-bot"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}